{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Template used to create glue backfill ETL job",
  "Resources": {
    "AWSGlueJobRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "glue.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "Glue",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "glue:*",
                    "cloudwatch:PutMetricData"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "IAM",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "iam:ListRolePolicies",
                    "iam:GetRole",
                    "iam:GetRolePolicy"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "ReadWriteS3",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:AbortMultipartUpload",
                    "s3:GetBucketLocation",
                    "s3:GetObject",
                    "s3:ListBucket",
                    "s3:ListBucketMultipartUploads",
                    "s3:PutObject"
                  ],
                  "Resource": [
                    "arn:aws:s3:::prod.snapshot.record.sagebase.org",
                    "arn:aws:s3:::prod.snapshot.record.sagebase.org/*",
                    "arn:aws:s3:::prod.log.sagebase.org",
                    "arn:aws:s3:::prod.log.sagebase.org/*",
                    "arn:aws:s3:::prod.aws-glue.sagebase.org",
                    "arn:aws:s3:::prod.aws-glue.sagebase.org/*"
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "GlueStudioAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject"
                  ],
                  "Resource": [
                    "arn:aws:s3:::aws-glue-studio-transforms-510798373988-prod-us-east-1/*"
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "Log",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": [
                    "arn:aws:logs:*:*:/aws-glue/*"
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "backfillolddatawarehousefiledownloadrecordsGlueJob": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Command": {
          "Name": "glueetl",
          "ScriptLocation": "s3://prod.aws-glue.sagebase.org/scripts/backfill/backfill_old_dataware_house_file_download_records.py"
        },
        "DefaultArguments": {
          "--enable-continuous-cloudwatch-log": "true",
          "--job-bookmark-option": "job-bookmark-disable",
          "--enable-metrics": "true",
          "--enable-spark-ui": "true",
          "--job-language": "python",
          "--S3_SOURCE_PATH": "s3://prod.snapshot.record.sagebase.org/",
          "--RELEASE_NUMBER": "000000400",
          "--DATABASE_NAME": "warehouse",
          "--TABLE_NAME": "allfiledownloads",
          "--FILE_DOWNLOAD_TYPE": "filedownloadrecord",
          "--STACK": "prod",
          "--extra-py-files": "s3://prod.aws-glue.sagebase.org/scripts/backfill/backfill_utils.py,s3://aws-glue-studio-transforms-510798373988-prod-us-east-1/gs_explode.py,s3://aws-glue-studio-transforms-510798373988-prod-us-east-1/gs_common.py"
        },
        "Description": "This job back fill the old data-ware house file download records",
        "GlueVersion": "4.0",
        "Name": "warehouse_backfill_old_datawarehouse_filedownload_records",
        "Role": {
          "Fn::GetAtt": [
            "AWSGlueJobRole",
            "Arn"
          ]
        }
      }
    },
    "backfillkinesisfiledownloadrecordsGlueJob": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Command": {
          "Name": "glueetl",
          "ScriptLocation": "s3://prod.aws-glue.sagebase.org/scripts/backfill/backfill_kinesis_file_download_records.py"
        },
        "DefaultArguments": {
          "--enable-continuous-cloudwatch-log": "true",
          "--job-bookmark-option": "job-bookmark-disable",
          "--enable-metrics": "true",
          "--enable-spark-ui": "true",
          "--job-language": "python",
          "--S3_SOURCE_PATH": "s3://prod.log.sagebase.org/fileDownloads/records/",
          "--YEAR": "2023/",
          "--MONTH": "08/",
          "--DAY": "01/",
          "--DATABASE_NAME": "warehouse",
          "--TABLE_NAME": "allfiledownloads",
          "--extra-py-files": "s3://prod.aws-glue.sagebase.org/scripts/backfill/backfill_utils.py"
        },
        "Description": "This job back fill the kinesis file download records",
        "GlueVersion": "4.0",
        "Name": "warehouse_backfill_kinesis_filedownload_records",
        "Role": {
          "Fn::GetAtt": [
            "AWSGlueJobRole",
            "Arn"
          ]
        }
      }
    },
    "processdeduplicatedfiledownloadrecordsGlueJob": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Command": {
          "Name": "glueetl",
          "ScriptLocation": "s3://prod.aws-glue.sagebase.org/scripts/backfill/process_backfill_file_download_records_after_deduplication.py"
        },
        "DefaultArguments": {
          "--enable-continuous-cloudwatch-log": "true",
          "--job-bookmark-option": "job-bookmark-enable",
          "--enable-metrics": "true",
          "--enable-spark-ui": "true",
          "--job-language": "python",
          "--S3_SOURCE_PATH": "s3://prod.log.sagebase.org/duplicatedownloads/",
          "--FORMAT": "json",
          "--S3_DESTINATION_PATH": "s3://prod.log.sagebase.org/fileDownloadRecords/records/",
          "--extra-py-files": "s3://prod.aws-glue.sagebase.org/scripts/backfill/backfill_utils.py"
        },
        "Description": "This job back fill the kinesis file download records",
        "GlueVersion": "4.0",
        "Name": "warehouse_process_duplicate_filedownload_records",
        "Role": {
          "Fn::GetAtt": [
            "AWSGlueJobRole",
            "Arn"
          ]
        }
      }
    },
    "duplicatefiledownloadGlueTable": {
      "Type": "AWS::Glue::Table",
      "Properties": {
        "CatalogId": {
          "Ref": "AWS::AccountId"
        },
        "DatabaseName": "warehouse",
        "TableInput": {
          "Name": "allfiledownloads",
          "Description" : "This table contains all the filed downloads of old data-ware house downloads and kinesis stream download.",
          "StorageDescriptor" : {
            "Columns": [
              {
                "Name": "timestamp",
                "Type": "timestamp"
              },
              {
                "Name": "user_id",
                "Type": "bigint"
              },
              {
                "Name": "project_id",
                "Type": "bigint"
              },
              {
                "Name": "file_handle_id",
                "Type": "string"
              },
              {
                "Name": "downloaded_file_handle_id",
                "Type": "string"
              },
              {
                "Name": "association_object_id",
                "Type": "string"
              },
              {
                "Name": "association_object_type",
                "Type": "string"
              },
              {
                "Name": "stack",
                "Type": "string"
              },
              {
                "Name": "instance",
                "Type": "string"
              }],
            "InputFormat": "org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat",
            "SerdeInfo": {
              "SerializationLibrary": "org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe"
            },
            "Compressed": true,
            "Location": "s3://prod.log.sagebase.org/alldownloads/"
          },
          "PartitionKeys": [
            {
              "Name": "record_date",
              "Type": "date"
            }],
          "TableType": "EXTERNAL_TABLE"
        }
        }
      }
    }
  }